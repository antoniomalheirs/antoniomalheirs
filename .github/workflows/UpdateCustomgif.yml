name: Generate GitHub Stats GIFs

on:
  schedule:
    # Executa todos os dias às 12:00 UTC
    - cron: "0 12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  Generate-Stats-and-GIFs:
    runs-on: ubuntu-latest
    concurrency:
      group: stats-concurrency
      cancel-in-progress: true
    steps:
      # Passo 1: Faz o checkout do seu repositório principal
      - name: Checkout Main Repo
        uses: actions/checkout@v3

      # Passo 2: Gera o arquivo JSON com as estatísticas
      - name: Generate Stats File
        uses: LukeHagar/stats-action@main
        with:
          output_path: generated/stats.json
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

      # --- INÍCIO DA CORREÇÃO ---

      # Passo 3: Faz o checkout do repositório do Remotion para uma pasta separada
      - name: Checkout Remotion Project
        uses: actions/checkout@v3
        with:
          repository: lukeHagar/github-stats-remotion
          path: remotion-project # Baixa o projeto para a pasta 'remotion-project'

      # Passo 4: Configura o ambiente Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Use a versão do Node.js exigida pelo projeto Remotion
          cache: 'npm'
          cache-dependency-path: 'remotion-project/package-lock.json'

      # Passo 5: Instala as dependências e renderiza o vídeo
      - name: Install Dependencies and Render GIF
        run: |
          # Copia o arquivo de stats para dentro do projeto Remotion
          cp generated/stats.json remotion-project/
          
          # Entra na pasta do projeto, instala dependências e roda o build
          cd remotion-project
          npm install
          npm run build # Este comando irá renderizar o vídeo/gif
          
          # Copia o GIF gerado para uma pasta no seu repositório principal
          cp out/stats.gif ../public/github-stats.gif
        env:
          # (Opcional) Passa a localização do arquivo de stats como variável de ambiente
          STATS_FILE_PATH: 'stats.json'

